no(1,ana,[natureza,pintura,musica,sw,porto],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).

no(11,antonio,[natureza,pintura,carros,futebol,lisboa],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(12,beatriz,[natureza,musica,carros,porto,moda],0.1,0.2,0.3,0.4,0.6,0.6,0.7,0.8,0.9,0.3).
no(13,carlos,[natureza,musica,sw,futebol,coimbra],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(14,daniel,[natureza,cinema,jogos,sw,moda],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(15,afonso,[natureza,pintura,carros,futebol,lisboa],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(16,artur,[natureza,musica,carros,porto,moda],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).

no(21,eduardo,[natureza,cinema,teatro,carros,coimbra],0.1,0.2,0.3,0.4,0.6,0.6,0.7,0.8,0.9,0.3).
no(22,isabel,[natureza,musica,porto,lisboa,cinema],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(23,jose,[natureza,pintura,sw,musica,carros,lisboa],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(24,luisa,[natureza,cinema,jogos,moda,porto],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(25,bento,[natureza,pintura,carros,futebol,lisboa],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(26,benjamim,[natureza,musica,carros,porto,moda],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).

no(31,maria,[natureza,pintura,musica,moda,porto],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(32,anabela,[natureza,cinema,musica,tecnologia,porto],0.1,0.7,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(33,andre,[natureza,carros,futebol,coimbra],0.1,0.2,0.3,0.4,0.6,0.6,0.7,0.8,0.9,0.3).
no(34,catia,[natureza,musica,cinema,lisboa,moda],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(35,ethan,[natureza,pintura,carros,futebol,lisboa],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(36,erik,[natureza,musica,carros,porto,moda],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).

no(41,cesar,[natureza,teatro,tecnologia,futebol,porto],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(42,diogo,[natureza,futebol,sw,jogos,porto],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(43,ernesto,[natureza,teatro,carros,porto],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(44,isaura,[natureza,moda,tecnologia,cinema],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(45,fabricio,[natureza,pintura,carros,futebol,lisboa],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(46,gregorio,[natureza,musica,carros,porto,moda],0.1,0.2,0.6,0.4,0.5,0.6,0.7,0.8,0.9,0.3).

no(51,rodolfo,[natureza,musica,sw],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(52,aurora,[natureza,futebol,sw,jogos,porto],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(53,anastacia,[natureza,teatro,carros,porto],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(54,bianca,[natureza,moda,tecnologia,cinema],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(55,cecilia,[natureza,pintura,carros,futebol,lisboa],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).
no(56,flora,[natureza,musica,carros,porto,moda],0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.3).

ligacao(1,11,10,8,12,4).
ligacao(1,12,2,6,4,5).
ligacao(1,13,-3,-2,1,-3).
/*ligacao(1,17,24,8,9,4).*/
ligacao(1,14,1,-5,1,4).
ligacao(11,21,5,7,2,-5).
ligacao(11,22,2,-4,1,4).
ligacao(11,23,-2,8,-5,3).
ligacao(11,24,6,0,4,-5).
ligacao(12,21,4,9,4,5).
ligacao(12,22,-3,-8,1,7).
ligacao(12,23,2,4,3,-6).
ligacao(12,24,-2,4,4,1).
ligacao(13,21,3,2,4,-6).
ligacao(13,22,0,-3,2,-6).
ligacao(13,23,5,9,4,-8).
ligacao(13,24,-2, 4,2,4).
ligacao(14,21,2,6,5,7).
ligacao(14,22,6,-3,2,-5).
ligacao(14,23,7,0,2,8).
ligacao(14,24,2,2,2,5).
ligacao(17,21,8,6,6,9).
ligacao(17,23,2,2,4,5).
ligacao(17,22,20,2,4,5).
ligacao(17,24,17,2,5,4).
ligacao(21,31,2,1,-4,5).
ligacao(21,32,-2,3,6,2).
ligacao(21,34,4,2,1,-5).
ligacao(21,33,3,5,5,2).
ligacao(22,31,5,-4,3,5).
ligacao(22,32,-1,6,3,-5).
ligacao(22,33,2,1,4,6).
ligacao(22,34,2,3,2,-5).
ligacao(23,31,4,-3,4,6).
ligacao(23,32,3,5,2,1).
ligacao(23,33,4,1,2,4).
ligacao(23,34,-2,-3,2,4).
ligacao(24,31,1,-5,2,-4).
ligacao(24,32,1,0,2,4).
ligacao(24,33,3,-1,2,1).
ligacao(24,34,-1,5,1,6).
ligacao(31,41,2,4,4,2).
ligacao(31,42,6,3,3,8).
ligacao(31,43,2,1,-1,3).
ligacao(31,44,2,1,1,6).
ligacao(32,41,2,3,-7,2).
ligacao(32,42,-1,0,2,-4).
ligacao(32,43,0,1,1,4).
ligacao(32,44,1,2,1,1).
ligacao(33,41,4,-1,6,4).
ligacao(33,42,-1,3,4,-4).
ligacao(33,43,7,2,2,6).
ligacao(33,44,5,-3,-5,3).
ligacao(34,41,3,2,4,6).
ligacao(34,42,1,-1,2,-4).
ligacao(34,43,2,4,4,-5).


esperanca(1,[11,12,13]).
esperanca(21,[22,23]).

medo(1,[31,32,33]).
medo(21,[12,13]).


orgulho(1,[11,12],natureza).
orgulho(1,[13],coimbra).


remorso(1,[22,23],moda).
remorso(21,[12,32],natureza).

% Algoritmo sugestão de grupos
% N número de utilizadores maximo, T número de tags em comum, L - Lista de tags obrigatórias.

:- dynamic grupo_maior/3.

algoritmo_sugerir_grupos(User,NElem,NTags,ListObrig,R):-
    asserta(grupo_maior(_,-1,_)),
    findall(X,no(_,X,_,_,_,_,_,_,_,_,_,_,_),ListUsers),
    length(ListObrig,N),
    NTotal is NTags - N,
    no(_,User,ListTagsUser,_,_,_,_,_,_,_,_,_,_),
    diferenca(ListTagsUser,ListObrig,ListFinal),
    todas_combinacoes_tags(NTotal,ListFinal,ListObrig,CombinacoesTags),
    ver_grupos(CombinacoesTags,ListUsers,NElem,R),
    retract(grupo_maior(ListMembros,TamanhoMaior,ListTagsComum)),
    TamanhoMaior \= -1,
    nl,write('################# Grupo Sugerido #################'),nl,nl,
    write('Lista de Membros: '),write(ListMembros),nl,
    write('Tamanho: '),write(TamanhoMaior),nl,
    write('Lista de Tags Comum: '),write(ListTagsComum),nl,
    nl,write('##################################################'),nl,nl,!.

algoritmo_sugerir_grupos(_,_,_,_,_):-
    nl,write('################### Grupo Sugerido ###################'),nl,nl,
    write('Nao existe nenhum grupo com as especificacoes pedidas.'),nl,nl,
    write('######################################################'),nl,nl.

% diferança entre duas listas
diferenca_beta([ ],_,[ ]).
diferenca_beta([X|L1],L2,[X|LI]):-not(member(X,L2)),!,diferenca_beta(L1,L2,LI).
diferenca_beta([_|L1],L2,LI):-diferenca_beta(L1,L2,LI).

diferenca(L1,L2,L3):-diferenca_beta(L1,L2,L4),diferenca_beta(L2,L1,L5),uniao(L4,L5,L3).

% uniao de duas listas
uniao([ ],L,L).
uniao([X|L1],L2,LU):-member(X,L2),!,uniao(L1,L2,LU).
uniao([X|L1],L2,[X|LU]):-uniao(L1,L2,LU).

% todas as combinações comuns tendo em conta as tags obrigatorias e o numero de tags
todas_combinacoes_tags(X,LTags,ListObrig,LcombXTags):-findall(L,combinacao(X,LTags,L,ListObrig),LcombXTags).

combinacao(0,_,Resultado,ListObrig):- Resultado = ListObrig,!.
combinacao(X,[Tag|L],[Tag|T],ListObrig):-X1 is X-1, combinacao(X1,L,T,ListObrig).
combinacao(X,[_|L],T,ListObrig):- combinacao(X,L,T,ListObrig).

% criar os grupos e tendo em conta as combinações das tags
ver_grupos([],_,_,_):-!.
ver_grupos([H|CombinacoesTags],ListUsers,NElem,R):-
    ListUsersAux = ListUsers,
    TagsComumGrupo = H,
    criar_grupo(ListUsersAux,TagsComumGrupo,[],Grupo),
    length(Grupo,TamanhoGrupo),
    TamanhoGrupo >= NElem,
    grupo_maior(_,Maior,_),
    TamanhoGrupo >= Maior,
    retract(grupo_maior(_,_,_)),asserta(grupo_maior(Grupo,TamanhoGrupo,H)),
    ver_grupos(CombinacoesTags,ListUsers,NElem,R),!.

ver_grupos([_|CombinacoesTags],ListUsers,NElem,R):-
    ver_grupos(CombinacoesTags,ListUsers,NElem,R).

% cria a possiblidade de um grupo com as tags em comum
criar_grupo([],_,Grupo,Resultado):- Resultado = Grupo,!.
criar_grupo([User|ListUsersAux],TagsComumGrupo,Grupo,Resultado):-
    no(_,User,ListaTags,_,_,_,_,_,_,_,_,_,_),
    tem_tags_comum(TagsComumGrupo,ListaTags),
    append(Grupo, [User], GruposNovos),
    criar_grupo(ListUsersAux, TagsComumGrupo, GruposNovos,Resultado),!.

criar_grupo([_|ListUsersAux],TagsComumGrupo,Grupo,Resultado):-
    criar_grupo(ListUsersAux, TagsComumGrupo, Grupo, Resultado),!.

% verifica se as o user tem todas as tags precisas
tem_tags_comum(List1,List2):-
    forall(member(Element,List1), member(Element,List2)).

append([ ], Y, Y).
append([X|L1],L2,[X|L3]):-append(L1,L2,L3).

% Verificação dos níveis de emoção

verifyEmotions(NAngustiado,NMedroso,NDesapontado,NRemorsos,NNervoso):-
        LVL is 0.5,
        NAngustiado =< LVL, 
        NMedroso =< LVL, 
        NDesapontado =< LVL, 
        NRemorsos =< LVL, 
        NNervoso =< LVL.

% Algoritmo Best First (Com Função Multicritério, apenas um resultado e consideração de estados de humor)

bestfs1_mc_one(Orig,Dest,Cam,Custo,N):-
                bestfs12_mc_one(Dest,[[Orig]],Cam,Custo,N).

bestfs12_mc_one(Dest,[[Dest|T]|_],Cam,Custo,_):-
                reverse([Dest|T],Cam), 
                calcula_custo_mc(Cam,Custo),
                write('Caminho='),write(Cam),nl,
                !.

bestfs12_mc_one(Dest,[[Dest|_]|_],_,_,_):-
                !.

bestfs12_mc_one(Dest,LLA,Cam,Custo,N):-
                member1(LA,LLA,LLA1),LA=[Act|_],
                length(LA,Tamanho),
                Tamanho =< N,
                ((Act==Dest,!,bestfs12_mc_one(Dest,[LA|LLA1],Cam,Custo,N)) ; (findall((CX,[X|LA]),
                (no(NAct,Act,_,_,_,_,_,_,_,_,_,_,_),no(NX,X,_,NAngustiado,NMedroso,NDesapontado,NRemorsos,NNervoso,_,_,_,_,_),
                verifyEmotions(NAngustiado,NMedroso,NDesapontado,NRemorsos,NNervoso),
                (ligacao(NAct,NX,FL,_,FR,_);ligacao(NX,NAct,_,FL,_,FR)),CX is FL+FR,
                \+member(X,LA)),Novos),
                Novos\==[],!,
                sort(0,@>=,Novos,NovosOrd),
                retira_custos(NovosOrd,NovosOrd1),
                append(NovosOrd1,LLA1,LLA2),
                %write('LLA2='),write(LLA2),nl,
                bestfs12_mc_one(Dest,LLA2,Cam,Custo,N))).

member1(LA,[LA|LAA],LAA).
member1(LA,[_|LAA],LAA1):- member1(LA,LAA,LAA1).

retira_custos([],[]).
retira_custos([(_,LA)|L],[LA|L1]):- retira_custos(L,L1).

calcula_custo_mc([Act,X],R):-!,
                 no(NAct,Act,_,_,_,_,_,_,_,_,_,_,_),
                 no(NX,X,_,_,_,_,_,_,_,_,_,_,_),
                 (ligacao(NAct,NX,FL,_,FR,_);ligacao(NX,NAct,_,FL,_,FR)),
                 multicriterio(FL, FR, R).

calcula_custo_mc([Act,X|L],P):-calcula_custo_mc([X|L],P1), 
                 no(NAct,Act,_,_,_,_,_,_,_,_,_,_,_),
                 no(NX,X,_,_,_,_,_,_,_,_,_,_,_),
                 (ligacao(NAct,NX,FL,_,FR,_);ligacao(NX,NAct,_,FL,_,FR)),
                 multicriterio(FL, FR, R),
                 P is P1 + R.


% Algoritmo Best First (Com Função Multicritério, vários resultados e consideração de estados de humor)

bestfs1_mc(Orig,Dest,Cam,Custo,N):-
                bestfs12_mc(Dest,[[Orig]],Cam,Custo,N),
                write('Caminho='),write(Cam),nl.

bestfs12_mc(Dest,[[Dest|T]|_],Cam,Custo,_):-
                reverse([Dest|T],Cam), calcula_custo_mc(Cam,Custo).

bestfs12_mc(Dest,[[Dest|_]|LLA2],Cam,Custo,N):-
                !,bestfs12_mc(Dest,LLA2,Cam,Custo,N).

bestfs12_mc(Dest,LLA,Cam,Custo,N):-
                member1(LA,LLA,LLA1),LA=[Act|_],
                length(LA,Tamanho),
                Tamanho =< N,
                ((Act==Dest,!,bestfs12_mc(Dest,[LA|LLA1],Cam,Custo,N)) ; (findall((CX,[X|LA]),
                (no(NAct,Act,_,_,_,_,_,_,_,_,_,_,_),no(NX,X,_,NAngustiado,NMedroso,NDesapontado,NRemorsos,NNervoso,_,_,_,_,_),
                verifyEmotions(NAngustiado,NMedroso,NDesapontado,NRemorsos,NNervoso),
                (ligacao(NAct,NX,FL,_,FR,_);ligacao(NX,NAct,_,FL,_,FR)),CX is FL+FR,
                \+member(X,LA)),Novos),
                Novos\==[],!,
                sort(0,@>=,Novos,NovosOrd),
                retira_custos(NovosOrd,NovosOrd1),
                append(NovosOrd1,LLA1,LLA2),
                %write('LLA2='),write(LLA2),nl,
                bestfs12_mc(Dest,LLA2,Cam,Custo,N))).

%member1(LA,[LA|LAA],LAA).
%member1(LA,[_|LAA],LAA1):- member1(LA,LAA,LAA1).

%retira_custos([],[]).
%retira_custos([(_,LA)|L],[LA|L1]):- retira_custos(L,L1).

%calcula_custo_mc([Act,X],R):-!,
%                no(NAct,Act,_),
%                no(NX,X,_),
%                (ligacao(NAct,NX,FL,_,FR,_);ligacao(NX,NAct,_,FL,_,FR)),
%                multicriterio(FL, FR, R).

%calcula_custo_mc([Act,X|L],P):-calcula_custo_mc([X|L],P1), 
%                no(NAct,Act,_),
%                no(NX,X,_),
%                (ligacao(NAct,NX,FL,_,FR,_);ligacao(NX,NAct,_,FL,_,FR)),
%                multicriterio(FL, FR, R),
%                P is P1 + R.


% Função Multicritério

multicriterio(FL, FR, R):- 
    ((FL < 50, with_FL_0(FL,FR,R)); 
    (FL < 100, with_FL_50(FL,FR,R)); 
    (FL = 100, with_FL_100(FL,FR,R))),!.

with_FL_0(FL, FR, R):-
    ((FR =< -200, with_FL_0_FR_smaller(FL,FR,R));
    (FR >= 200, with_FL_0_FR_upper(FL,FR,R));
    with_FL_0_FR_equal(FL,FR,R)).

with_FL_50(FL,FR,R):-
    ((FR =< -200, with_FL_50_FR_smaller(FL,FR,R));
    (FR >= 200, with_FL_50_FR_upper(FL,FR,R));
    with_FL_50_FR_equal(FL,FR,R)).

with_FL_100(FL,FR,R):-
    ((FR =< -200, with_FL_100_FR_smaller(FL,FR,R));
    (FR >= 200, with_FL_100_FR_upper(FL,FR,R));
    with_FL_100_FR_equal(FL,FR,R)).

with_FL_0_FR_smaller(_,_,R):- R is 0.
with_FL_0_FR_upper(_,_,R):- R is 50.
with_FL_0_FR_equal(_,_,R):- R is 25.

with_FL_50_FR_smaller(_,_,R):- R is 25.
with_FL_50_FR_upper(_,_,R):- R is 75.
with_FL_50_FR_equal(_,_,R):- R is 50.

with_FL_100_FR_smaller(_,_,R):- R is 50.
with_FL_100_FR_upper(_,_,R):- R is 100.
with_FL_100_FR_equal(_,_,R):- R is 75.

% Algoritmo A* (Com Função MultiCritério e consideração de estados de humor)

aStar_cmc(Orig,Dest,Cam,Custo,N):-
    forcas_ligacao_decrescente_cmc(Orig,N,RedeUtilizadores),
    aStar2_cmc(Dest,[(_,0,[Orig])],RedeUtilizadores,Cam,Custo,N),!.

aStar2_cmc(Dest,[(_,Custo,[Dest|T])|_],_,Cam,Custo,_):-
        reverse([Dest|T],Cam).

aStar2_cmc(Dest,[(_,Ca,LA)|Outros],RedeUtilizadores,Cam,Custo,N):-
        LA=[Act|_],
        length(LA,C),
        findall((CEX,CaX,[X|LA]),
        (C=<N,
        Dest\==Act,
        no(Act,_,_,_,_,_,_,_,_,_,_,_,_),
        no(X,_,_,NAngustiado,NMedroso,NDesapontado,NRemorsos,NNervoso,_,_,_,_,_),
        verifyEmotions(NAngustiado,NMedroso,NDesapontado,NRemorsos,NNervoso),
        (ligacao(Act,X,ForcaX,_,ForcaY,_);ligacao(X,Act,_,ForcaX,_,ForcaY)),
        \+ member(X,LA),multicriterio(ForcaX,ForcaY,Resultado),
        CaX is Resultado + Ca,
        estimativa(Resultado,X,Dest,C,N,RedeUtilizadores,EstX),
        CEX is CaX + EstX),Novos),
        append(Outros,Novos,Todos),
        sort(0,@>=,Todos,TodosOrd),
        eliminar(TodosOrd,RedeUtilizadores,RedeUtilizadoresAtualizado),
        aStar2_cmc(Dest,TodosOrd,RedeUtilizadoresAtualizado,Cam,Custo,N).

forcas_ligacao_decrescente_cmc(Orig,N,Lista):-
        tamanho_rede_utilizadores(Orig,N,RedeUtilizadores),
        forcas_ligacao_decrescente_2_cmc(RedeUtilizadores,ListaInt),
        flatten(ListaInt,ListaInt2),
        sort(0,@>=,ListaInt2,Lista).								

forcas_ligacao_decrescente_2_cmc([_],[]):-!.
forcas_ligacao_decrescente_2_cmc([User1|Y],[RedeUtilizadores|Z]):-
        findall([F1,F2,F3,F4],
        (member(User2,Y),
        (ligacao(User1,User2,F1,F2,F3,F4);ligacao(User2,User1,F2,F1,F4,F3))),RedeUtilizadores),
        forcas_ligacao_decrescente_2(Y,Z).

estimativa(_,Dest,Dest,_,_,_,0):- !.
estimativa(ForcaX,_,_,Atual,Destino,ListaInt,Estimativa):-
        Index is Destino - Atual,
        apaga_primeiro(ForcaX,ListaInt,Resultado),
        somar_Forca_N(0,Index,Resultado,Estimativa).

apaga_primeiro(_, [], []).
apaga_primeiro(Term, [Term|Tail], Tail).
apaga_primeiro(Term, [Head|Tail], [Head|Result]) :-
apaga_primeiro(Term, Tail, Result).

somar_Forca_N(N,N,_,0):-!.
somar_Forca_N(C,N,[H|T],S):- 
        C1 is C+1, 
        somar_Forca_N(C1,N,T,S1), 
        S is H + S1.

eliminar([(_,_,[B,A|_])|_],L,NL):-
        ((ligacao(A,B,Custo,_,_,_),!);(ligacao(B,A,_,Custo,_,_))),
        apaga_primeiro(Custo,L,NL).


% Forças de ligação decrescente - Retorna uma lista ordenada das forças de ligação correspondente para a rede de utilizadores até N nível.
forcas_ligacao_decrescente(Orig,N,Lista):-
        tamanho_rede_utilizadores(Orig,N,RedeUtilizadores),
        forcas_ligacao_decrescente_2(RedeUtilizadores,ListaInt),
        flatten(ListaInt,ListaInt2),
        sort(0,@>=,ListaInt2,Lista).								

forcas_ligacao_decrescente_2([_],[]):-!.
forcas_ligacao_decrescente_2([User1|Y],[RedeUtilizadores|Z]):-
        findall([F1,F2],
        (member(User2,Y),
        (ligacao(User1,User2,F1,F2,_,_);ligacao(User2,User1,F2,F1,_,_))),RedeUtilizadores),
        forcas_ligacao_decrescente_2(Y,Z).

% Tamanho rede de utilizadores - Retorna a lista de users até determinado nível
tamanho_rede_utilizadores(Origem,Nivel,Solucao):- 
        tamanho_rede_utilizadores_nivelX([Origem],Nivel,ListaA),
        flatten(ListaA,ListaB),
        sort(ListaB,ListaE),
        Solucao = ListaE.

tamanho_rede_utilizadores_nivelX(_,0,[]):-!.

tamanho_rede_utilizadores_nivelX(ListaB,Nivel,[ListaC|ListaA]):- 
        NY is Nivel - 1,
        tamanho_rede_utilizadores_nivelY(ListaB,ListaI),
        flatten(ListaI,ListaC),
        tamanho_rede_utilizadores_nivelX(ListaC,NY,ListaA).

tamanho_rede_utilizadores_nivelY([],[]):-!.

tamanho_rede_utilizadores_nivelY([UserX|ListaB],[ListaD|ListaC]):- 
        findall(UserY,ligacao(UserX,UserY,_,_,_,_), ListaD),
        tamanho_rede_utilizadores_nivelY(ListaB,ListaC).


%-------------------------------------------------------------------------: ALGORITMOS MODELAÇÃO DE EMOÇÕES :-----------------------------------------------------------------------------------

%Alegria e Angustia

atualizarAlegriaAngustia(IdUser,AL,AN,R1,R2):-getSomaForcasRelacao(IdUser,SomaFinal),no(IdUser,_,_,AN,_,_,_,_,_,_,_,_,AL),
(SomaFinal>0,(calcularAumento(SomaFinal,AL,2,R1),calcularDiminuicao(SomaFinal,AN,2,R2));(calcularAumento(SomaFinal,2,AN,R1),
calcularDiminuicao(SomaFinal,2,AL,R2))),!.

getSomaForcasRelacao(IdUser,SomaFinal):-getAllUsers(ListaUsers),getAllForcasRelacao(ListaForcasRelacao),
somarForcas(IdUser,ListaUsers,ListaForcasRelacao,0,SomaFinal).

getAllUsers(L):-findall(X1,ligacao(X1,_,_,_,_,_),L).
getAllForcasRelacao(L1):- findall(X1,ligacao(_,_,_,_,X1,_),L1).

somarForcas(_,[],[],Soma,SomaFinal):-SomaFinal is Soma.
somarForcas(IdUser,[H|T],[G|L],Soma,SomaFinal):-IdUser=H,Soma1 is Soma+G,somarForcas(IdUser,T,L,Soma1,SomaFinal);somarForcas(IdUser,T,L,Soma,SomaFinal).

calcularAumento(SomaFinal,AL,AN,R1):-AN=2,calcularAumento2(SomaFinal,AL,Resultado),R1 is Resultado;calcularAumento2(-SomaFinal,AN,Resultado),R1 is Resultado.

calcularDiminuicao(SomaFinal,AN,AL,R2):-AL=2,calcularDiminuicao2(SomaFinal,AN,Resultado),R2 is Resultado;calcularDiminuicao2(-SomaFinal,AL,Resultado),R2 is Resultado.

calcularAumento2(SomaFinal,Valor,Resultado):-Resultado is Valor+(1-Valor)*(min(SomaFinal,200)/200).

calcularDiminuicao2(SomaFinal,Valor,Resultado):-Resultado is Valor*(1-(min(SomaFinal,200)/200)).

%Esperança,Medo,Alívio e Deceção
atualizarEsperancaMedo(IdUser,GrupoSugerido,E,M,A,D,ResultadoEsperanca,ResultadoAlivio,ResultadoMedo,ResultadoDececao):-no(IdUser,_,_,_,M,D,_,_,E,A,_,_,_),
calcularEsperanca(GrupoSugerido,IdUser,E,D,ResultadoEsperanca,ResultadoDececao),
calcularMedo(GrupoSugerido,IdUser,M,A,ResultadoMedo,ResultadoAlivio).

calcularEsperanca(GrupoSugerido,IdUser,E,D,ResultadoEsperanca,ResultadoDececao):- esperanca(IdUser,ListaUEsperanca),
procurarUsersEmComum(GrupoSugerido,ListaUEsperanca,0,ResultadoFinal),
length(ListaUEsperanca,X),definirAumentoOuDiminuicaoEsperanca(X,ResultadoFinal,E,D,ResultadoEsperanca,ResultadoDececao).

calcularMedo(GrupoSugerido,IdUser,M,A,ResultadoMedo,ResultadoAlivio):-medo(IdUser,ListaUMedo),procurarUsersEmComum(GrupoSugerido,ListaUMedo,0,ResultadoFinal),
length(ListaUMedo,X),definirAumentoOuDiminuicaoMedo(X,ResultadoFinal,M,A,ResultadoMedo,ResultadoAlivio).

procurarUsersEmComum([],_,Count,ResultadoFinal):-!,ResultadoFinal is Count.
procurarUsersEmComum([H|T],ListaU,Count,ResultadoFinal):-procurarUsersEmComum2(H,ListaU,Count,Result),
procurarUsersEmComum(T,ListaU,Result,ResultadoFinal).

procurarUsersEmComum2(_,[],Count,Result):-!,Result is Count.
procurarUsersEmComum2(H,[X|Y],Count,Result):-H=X,Count1 is Count+1,procurarUsersEmComum2(H,[],Count1,Result);procurarUsersEmComum2(H,Y,Count,Result).

definirAumentoOuDiminuicaoEsperanca(X,ResultadoFinal,E,D,ResultadoEsperanca,ResultadoDececao):-(ResultadoFinal/X) = (1/2),ResultadoEsperanca is E,ResultadoDececao is D;
(ResultadoFinal/X) > (1/2),aumentoEmocao(X,ResultadoFinal,E,ResultadoEsperanca),diminuicaoEmocao(X,X-ResultadoFinal,D,ResultadoDececao);
diminuicaoEmocao(X,ResultadoFinal,E,ResultadoEsperanca),aumentoEmocao(X,X-ResultadoFinal,D,ResultadoDececao).

definirAumentoOuDiminuicaoMedo(X,ResultadoFinal,M,A,ResultadoMedo,ResultadoAlivio):-(ResultadoFinal/X) = (1/2),ResultadoMedo is M,ResultadoAlivio is A;(ResultadoFinal/X) > (1/2),
aumentoEmocao(X,ResultadoFinal,M,ResultadoMedo),diminuicaoEmocao(X,X-ResultadoFinal,A,ResultadoAlivio);diminuicaoEmocao(X,ResultadoFinal,M,ResultadoMedo),
aumentoEmocao(X,X-ResultadoFinal,A,ResultadoAlivio).

aumentoEmocao(X,ResultadoFinal,EmocaoValor,ResultadoAposMudanca):-ResultadoAposMudanca is EmocaoValor+(1-EmocaoValor)*(ResultadoFinal/X).
diminuicaoEmocao(X,ResultadoFinal,EmocaoValor,ResultadoAposMudanca):-ResultadoAposMudanca is EmocaoValor*(1-(ResultadoFinal/X)).

%Orgulho,Remorso,Gratidão e Raiva
atualizarOrgulhoRemorso(IdUser,Grupo,ListaTagsGrupo,O,RE,G,RA,ResultadoOrgulho,ResultadoRemorso,ResultadoGratidao,ResultadoRaiva):-
    no(IdUser,_,_,_,_,_,RE,RA,_,_,O,G,_),calculaOrgulho(Grupo,IdUser,O,RA,ResultadoOrgulho,ResultadoRaiva,ListaTagsGrupo),
    calculaRemorso(Grupo,IdUser,RE,G,ResultadoRemorso,ResultadoGratidao,ListaTagsGrupo),!.


calculaOrgulho(Grupo,IdUser,O,RA,ResultadoOrgulho,ResultadoRaiva,ListaTagsGrupo):-findall(X,orgulho(IdUser,X,_),L),findall(X,orgulho(IdUser,_,X),L1),
percorrerListasOrgulho(L,L1,ListaTagsGrupo,Grupo,0,0,ResultadoTotalFinal,ResultadoTotalX)
,definirAumentoOuDiminuicaoOrgulho(ResultadoTotalX,ResultadoTotalFinal,O,RA,ResultadoOrgulho,ResultadoRaiva),!.

calculaRemorso(Grupo,IdUser,RE,G,ResultadoRemorso,ResultadoGratidao,ListaTagsGrupo):-findall(X,remorso(IdUser,X,_),L),findall(X,remorso(IdUser,_,X),L1),
percorrerListasRemorso(L,L1,ListaTagsGrupo,Grupo,0,0,ResultadoTotalFinal,ResultadoTotalX)
,definirAumentoOuDiminuicaoRemorso(ResultadoTotalX,ResultadoTotalFinal,RE,G,ResultadoRemorso,ResultadoGratidao),!.

percorrerListasRemorso([],[],_,_,ResultadoFinal,X,ResultadoTotalFinal,ResultadoTotalX):-ResultadoTotalFinal is ResultadoFinal,ResultadoTotalX is X,!.
percorrerListasRemorso([H|L],[P|T],ListaTagsGrupo,Grupo,ResultadoFinal,X,ResultadoTotalFinal,ResultadoTotalX):-
percorrerListasRemorso2(H,P,ListaTagsGrupo,Grupo,ResultadoFinalRetornado,XRetornado),ResultadoTotalFinal1 is ResultadoFinalRetornado+ResultadoFinal,
X1 is XRetornado+X,percorrerListasRemorso(L,T,ListaTagsGrupo,Grupo,ResultadoTotalFinal1,X1,ResultadoTotalFinal,ResultadoTotalX).

percorrerListasOrgulho([],[],_,_,ResultadoFinal,X,ResultadoTotalFinal,ResultadoTotalX):-
    ResultadoTotalFinal is ResultadoFinal,ResultadoTotalX is X,!.
percorrerListasOrgulho([H|L],[P|T],ListaTagsGrupo,Grupo,ResultadoFinal,X,ResultadoTotalFinal,ResultadoTotalX):-
percorrerListasOrgulho2(H,P,ListaTagsGrupo,Grupo,ResultadoFinalRetornado,XRetornado),
ResultadoTotalFinal1 is ResultadoFinalRetornado+ResultadoFinal,
X1 is XRetornado+X,percorrerListasOrgulho(L,T,ListaTagsGrupo,Grupo,ResultadoTotalFinal1,X1,ResultadoTotalFinal,ResultadoTotalX).

percorrerListasOrgulho2(ListaUOrgulho,Tag,ListaTagsGrupo,Grupo,ResultadoFinal,X):-member(Tag,ListaTagsGrupo),
procurarUsersEmComum(Grupo,ListaUOrgulho,0,ResultadoFinal),
length(ListaUOrgulho,X);ResultadoFinal is 0,X is 0.

percorrerListasRemorso2(ListaUOrgulho,Tag,ListaTagsGrupo,Grupo,ResultadoFinal,X):-member(Tag,ListaTagsGrupo),
procurarUsersEmComumRemorso(Grupo,ListaUOrgulho,0,ResultadoFinal),
length(ListaUOrgulho,X);ResultadoFinal is 0,X is 0.

procurarUsersEmComumRemorso(_,[],Count,ResultadoFinal):-!,ResultadoFinal is Count.
procurarUsersEmComumRemorso(Grupo,[H|T],Count,ResultadoFinal):-procurarUsersEmComumRemorso2(Grupo,H,Count,Result),
procurarUsersEmComumRemorso(Grupo,T,Result,ResultadoFinal).

procurarUsersEmComumRemorso2(Grupo,H,Count,Result):- \+ member(H,Grupo),Result is Count+1;Result is Count.


definirAumentoOuDiminuicaoOrgulho(X,ResultadoFinal,O,RA,ResultadoOrgulho,ResultadoRaiva):-(ResultadoFinal/X) = (1/2),ResultadoOrgulho is O,ResultadoRaiva is RA;
(ResultadoFinal/X) > (1/2),
aumentoEmocao(X,ResultadoFinal,O,ResultadoOrgulho),diminuicaoEmocao(X,X-ResultadoFinal,RA,ResultadoRaiva);diminuicaoEmocao(X,ResultadoFinal,O,ResultadoOrgulho),
aumentoEmocao(X,X-ResultadoFinal,RA,ResultadoRaiva).


definirAumentoOuDiminuicaoRemorso(X,ResultadoFinal,RE,G,ResultadoRemorso,ResultadoGratidao):-X=0,ResultadoRemorso is RE,ResultadoGratidao is G;
(ResultadoFinal/X) = (1/2),ResultadoRemorso is RE,ResultadoGratidao is G;(ResultadoFinal/X) > (1/2),
aumentoEmocao(X,ResultadoFinal,RE,ResultadoRemorso),diminuicaoEmocao(X,X-ResultadoFinal,G,ResultadoGratidao);diminuicaoEmocao(X,ResultadoFinal,RE,ResultadoRemorso),
aumentoEmocao(X,X-ResultadoFinal,G,ResultadoGratidao).

% Algoritmo DFS com funcao multicriterio e consideração de estados de humor

all_dfs(Nome1,Nome2,Cam):-
    dfs(Nome1,Nome2,Cam),!,
    length(Cam,NLCam),
    write(NLCam), nl,
    write('List of all the paths: '),
    write(Cam),nl,nl.

dfs(Orig,Dest,Cam):-dfs2(Orig,Dest,[Orig],Cam).
dfs2(Dest,Dest,LA,Cam):-!,reverse(LA,Cam).
dfs2(Act,Dest,LA,Cam):-
    no(NAct,Act,_,_,_,_,_,_,_,_,_,_,_),
    (ligacao(NAct,NX,_,_,_,_);ligacao(NX,NAct,_,_,_,_)),
    no(NX,X,_,NAngustiado,NMedroso,NDesapontado,NRemorsos,NNervoso,_,_,_,_,_),
    verifyEmotions(NAngustiado,NMedroso,NDesapontado,NRemorsos,NNervoso),
    \+ member(X,LA),
    dfs2(X,Dest,[X|LA],Cam).

compute_value(U1,U2,V):-!,
    ligacao(U1,U2,ForcaU1_U2,ForcaU2_U1,Likes,Deslikes),
    F is ForcaU1_U2 + ForcaU2_U1,
    LD is Likes - Deslikes,
    V is F * 1 + LD * 0.5,
    multicriterio(F,LD,V).
